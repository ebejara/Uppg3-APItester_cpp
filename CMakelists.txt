cmake_minimum_required(VERSION 3.14)
project(ApiTester)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
# Valfritt: Lägg executables i output-mappen
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_SOURCE_DIR}/output)

include(FetchContent)


set(BUILD_SHARED_LIBS OFF CACHE BOOL "" FORCE)  # Global statisk länkning

# För gtest – statisk
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
# För cpr
set(CPR_BUILD_SHARED OFF CACHE BOOL "" FORCE)    # Säkerställer att cpr blir statisk
# För curl (som cpr bygger in) – statisk
set(BUILD_CURL_EXE OFF CACHE BOOL "" FORCE)
set(CURL_USE_SCHANNEL ON CACHE BOOL "" FORCE)  # Använd Windows SSL (redan default)
set(CURL_STATICLIB ON CACHE BOOL "" FORCE)
# För spdlog – redan statisk, men säkerhets skull
set(SPDLOG_BUILD_SHARED OFF CACHE BOOL "" FORCE)
# ======================== GoogleTest ===========================
FetchContent_Declare(
    googletest
    GIT_REPOSITORY https://github.com/google/googletest.git
    GIT_TAG v1.14.0  # Stabil version
)

FetchContent_MakeAvailable(googletest)

# ======================== spdlog ===========================
FetchContent_Declare(
    spdlog
    GIT_REPOSITORY https://github.com/gabime/spdlog.git
    GIT_TAG v1.14.1  # Stabil version
)
FetchContent_MakeAvailable(spdlog)

# ======================== cpr (C++ Requests) ===========================
FetchContent_Declare(
    cpr
    GIT_REPOSITORY https://github.com/libcpr/cpr.git
    GIT_TAG 1.14.1  # Senaste versionen
)

set(CPR_CURL_USE_LIBPSL OFF CACHE BOOL "" FORCE)
set(CPR_USE_SYSTEM_LIB_PSL OFF CACHE BOOL "" FORCE)

FetchContent_MakeAvailable(cpr)

# ======================== Test executable ===========================
add_executable(test_api tests/test_integration.cpp)
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_SOURCE_DIR}/output)
target_include_directories(test_api PRIVATE include)
target_link_libraries(test_api PRIVATE gtest gtest_main spdlog::spdlog cpr::cpr)

enable_testing()
add_test(NAME ApiTests COMMAND test_api)